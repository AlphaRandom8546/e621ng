<%= content_tag(:video, nil, id: 'image', class: post.display_class_for(CurrentUser.user), :"data-original-width" => post.image_width, :"data-original-height" => post.image_height, "data-rescales": post.generated_samples ,:loop => "true", :controls => "controls", poster: post.is_ugoira? ? nil : post.large_file_url) do %>
  <% if post.is_ugoira? %>
    <%= content_tag(:source, nil, src: post.large_file_url, type: 'video/webm') %>
  <% else %>
    <%= content_tag(:source, nil, src: post.file_url_ext('webm'), type: 'video/webm') %>
    <% if post.has_sample_size?('original') %>
      <%= content_tag(:source, nil, src: post.file_url_ext('mp4'), type: 'video/mp4') %>
    <% end %>
  <% end %>
<% end %>

<%= javascript_tag nonce: true do -%>
  (function () {
    var videoEl = document.getElementById('image');
    var savedVolume = parseFloat(localStorage.getItem('video_volume') || '1.0');
    if (videoEl) {
      videoEl.volume = savedVolume;
      videoEl.addEventListener('volumechange', function (evt) {
      if (evt.target) {
        localStorage.setItem('video_volume', evt.target.volume);
      }
    });
  }
  })();
<% end -%>
